{"version":3,"file":"platform_location.js","sourceRoot":"","sources":["../../../../../../modules/@angular/platform-webworker/src/web_workers/worker/platform_location.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * @license\n * Copyright Google Inc. All Rights Reserved.\n *\n * Use of this source code is governed by an MIT-style license that can be\n * found in the LICENSE file at https://angular.io/license\n */\n\nimport {LocationChangeListener, PlatformLocation} from '@angular/common';\nimport {Injectable} from '@angular/core';\n\nimport {EventEmitter} from '../../facade/async';\nimport {ClientMessageBroker, ClientMessageBrokerFactory, FnArg, UiArguments} from '../shared/client_message_broker';\nimport {MessageBus} from '../shared/message_bus';\nimport {ROUTER_CHANNEL} from '../shared/messaging_api';\nimport {LocationType} from '../shared/serialized_types';\nimport {PRIMITIVE, Serializer} from '../shared/serializer';\n\nimport {deserializeGenericEvent} from './event_deserializer';\n\n\nexport class WebWorkerPlatformLocation extends PlatformLocation {\n  private _broker: ClientMessageBroker;\n  private _popStateListeners: Array<Function> = [];\n  private _hashChangeListeners: Array<Function> = [];\n  private _location: LocationType = null;\n  private _channelSource: EventEmitter<Object>;\n\n  constructor(\n      brokerFactory: ClientMessageBrokerFactory, bus: MessageBus, private _serializer: Serializer) {\n    super();\n    this._broker = brokerFactory.createMessageBroker(ROUTER_CHANNEL);\n\n    this._channelSource = bus.from(ROUTER_CHANNEL);\n    this._channelSource.subscribe({\n      next: (msg: {[key: string]: any}) => {\n        var listeners: Array<Function> = null;\n        if (msg.hasOwnProperty('event')) {\n          let type: string = msg['event']['type'];\n          if (type === 'popstate') {\n            listeners = this._popStateListeners;\n          } else if (type === 'hashchange') {\n            listeners = this._hashChangeListeners;\n          }\n\n          if (listeners !== null) {\n            let e = deserializeGenericEvent(msg['event']);\n            // There was a popState or hashChange event, so the location object thas been updated\n            this._location = this._serializer.deserialize(msg['location'], LocationType);\n            listeners.forEach((fn: Function) => fn(e));\n          }\n        }\n      }\n    });\n  }\n\n  /** @internal **/\n  init(): Promise<boolean> {\n    var args: UiArguments = new UiArguments('getLocation');\n\n    var locationPromise: Promise<LocationType> = this._broker.runOnService(args, LocationType);\n    return locationPromise.then(\n        (val: LocationType):\n            boolean => {\n              this._location = val;\n              return true;\n            },\n        (err): boolean => { throw new Error(err); });\n  }\n\n  getBaseHrefFromDOM(): string {\n    throw new Error(\n        'Attempt to get base href from DOM from WebWorker. You must either provide a value for the APP_BASE_HREF token through DI or use the hash location strategy.');\n  }\n\n  onPopState(fn: LocationChangeListener): void { this._popStateListeners.push(fn); }\n\n  onHashChange(fn: LocationChangeListener): void { this._hashChangeListeners.push(fn); }\n\n  get pathname(): string {\n    if (this._location === null) {\n      return null;\n    }\n\n    return this._location.pathname;\n  }\n\n  get search(): string {\n    if (this._location === null) {\n      return null;\n    }\n\n    return this._location.search;\n  }\n\n  get hash(): string {\n    if (this._location === null) {\n      return null;\n    }\n\n    return this._location.hash;\n  }\n\n  set pathname(newPath: string) {\n    if (this._location === null) {\n      throw new Error('Attempt to set pathname before value is obtained from UI');\n    }\n\n    this._location.pathname = newPath;\n\n    var fnArgs = [new FnArg(newPath, PRIMITIVE)];\n    var args = new UiArguments('setPathname', fnArgs);\n    this._broker.runOnService(args, null);\n  }\n\n  pushState(state: any, title: string, url: string): void {\n    var fnArgs =\n        [new FnArg(state, PRIMITIVE), new FnArg(title, PRIMITIVE), new FnArg(url, PRIMITIVE)];\n    var args = new UiArguments('pushState', fnArgs);\n    this._broker.runOnService(args, null);\n  }\n\n  replaceState(state: any, title: string, url: string): void {\n    var fnArgs =\n        [new FnArg(state, PRIMITIVE), new FnArg(title, PRIMITIVE), new FnArg(url, PRIMITIVE)];\n    var args = new UiArguments('replaceState', fnArgs);\n    this._broker.runOnService(args, null);\n  }\n\n  forward(): void {\n    var args = new UiArguments('forward');\n    this._broker.runOnService(args, null);\n  }\n\n  back(): void {\n    var args = new UiArguments('back');\n    this._broker.runOnService(args, null);\n  }\nstatic decorators: DecoratorInvocation[] = [\n{ type: Injectable },\n];\n/** @nocollapse */\nstatic ctorParameters: ({type: any, decorators?: DecoratorInvocation[]}|null)[] = [\n{type: ClientMessageBrokerFactory, },\n{type: MessageBus, },\n{type: Serializer, },\n];\n}\n\ninterface DecoratorInvocation {\n  type: Function;\n  args?: any[];\n}\n"]}